<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Manutenção Veicular</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' rx='20' fill='%230891B2'/%3E%3Cpath d='M21.1719 56.25L31.1719 32.0312C32.1094 29.5312 34.3594 28.125 36.8594 28.125H65.8594C68.3594 28.125 70.6094 29.5312 71.5469 32.0312L81.5469 56.25M21.1719 56.25H9.60938C8.26562 56.25 7.10938 57.4062 7.10938 58.75V73.75C7.10938 75.0938 8.26562 76.25 9.60938 76.25H16.4844C17.4219 79.5312 20.3594 81.875 23.9844 81.875C27.6094 81.875 30.5469 79.5312 31.4844 76.25H71.2344C72.1719 79.5312 75.1094 81.875 78.7344 81.875C82.3594 81.875 85.2969 79.5312 86.2344 76.25H93.1094C94.4531 76.25 95.6094 75.0938 95.6094 73.75V58.75C95.6094 57.4062 94.4531 56.25 93.1094 56.25H81.5469M21.1719 56.25H81.5469' stroke='white' stroke-width='6.25' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG0CzdlIQHNi1HA vegg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #report-section, #report-section * {
                visibility: visible;
            }
            #report-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            #print-btn, #share-btn, #back-to-app-btn {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- Login View -->
    <div id="login-container" class="w-full max-w-md text-center">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700">
            <h1 class="text-2xl font-bold text-cyan-400 mb-2">Calculadora Veicular</h1>
            <p class="text-gray-400 mb-8">Faça login para salvar e acessar seu histórico de qualquer lugar.</p>
            <button id="login-btn" class="w-full bg-white hover:bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-3 transition-transform transform hover:scale-105 shadow-lg">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                <span>Entrar com Google</span>
            </button>
        </div>
    </div>
    
    <!-- Main App View -->
    <div id="app-container" class="w-full max-w-md space-y-6 hidden">
        <!-- User Info and Logout -->
        <div class="bg-gray-800 p-3 sm:p-4 rounded-2xl shadow-lg border border-gray-700 flex justify-between items-center">
            <div id="user-info" class="text-sm text-gray-300 truncate pr-2"></div>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-lg transition-transform transform hover:scale-105 shadow-md flex-shrink-0">
                Sair
            </button>
        </div>

        <!-- Forms Container -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Add Trip Form -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
                <h2 class="text-xl font-bold text-cyan-400 mb-4 text-center">Adicionar Rodagem</h2>
                <form id="add-km-form" class="space-y-4">
                    <div>
                        <label for="new-km" class="block text-sm font-medium text-gray-300 mb-2">KM da Viagem</label>
                        <input type="number" id="new-km" name="new-km" placeholder="Ex: 50" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-500 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
                    </div>
                    <div>
                        <label for="new-obs" class="block text-sm font-medium text-gray-300 mb-2">Observação</label>
                        <input type="text" id="new-obs" name="new-obs" placeholder="Ex: Ida ao médico" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-500 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
                    </div>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-lg">
                        Adicionar
                    </button>
                </form>
            </div>

            <!-- Add Refueling Form -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
                <h2 class="text-xl font-bold text-yellow-400 mb-4 text-center">Adicionar Abastecimento</h2>
                <form id="add-refueling-form" class="space-y-4">
                    <div>
                        <label for="refueling-value" class="block text-sm font-medium text-gray-300 mb-2">Valor Abastecido (R$)</label>
                        <input type="number" id="refueling-value" name="refueling-value" step="0.01" placeholder="Ex: 100.00" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-500 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition">
                    </div>
                    <div>
                        <label for="refueling-obs" class="block text-sm font-medium text-gray-300 mb-2">Observação</label>
                        <input type="text" id="refueling-obs" name="refueling-obs" placeholder="Ex: Posto Shell" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-500 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition">
                    </div>
                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-lg">
                        Adicionar
                    </button>
                </form>
            </div>
        </div>

        <!-- History -->
        <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-400">Histórico Geral</h2>
                <button id="reset-btn" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-lg transition-transform transform hover:scale-105 shadow-md">
                    Resetar Tudo
                </button>
            </div>
            <div id="history-list" class="space-y-3 max-h-60 overflow-y-auto pr-2 mb-4">
                <p id="history-placeholder" class="text-gray-500 text-center py-4">Nenhum registro adicionado.</p>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-2 gap-4 text-center">
                <div>
                    <p class="text-gray-400">Total KM Rodados</p>
                    <p><span id="total-km" class="text-3xl font-bold text-white">0</span> <span class="text-gray-400">KM</span></p>
                </div>
                <div>
                    <p class="text-gray-400">Total Abastecido</p>
                    <p><span id="total-refueling" class="text-3xl font-bold text-white">0.00</span> <span class="text-gray-400">R$</span></p>
                </div>
            </div>
        </div>

        <!-- Calculation -->
        <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-700">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-cyan-400">Calcular Custo Final</h1>
                <p class="text-gray-400 mt-1">Com base no histórico e abastecimentos.</p>
            </div>
            <form id="maintenance-form" class="space-y-6">
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-300 mb-2">Preço do Litro de Combustível (R$)</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">R$</span>
                        <input type="number" id="price" name="price" step="0.01" placeholder="Ex: 5.89" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 pl-10 text-white placeholder-gray-500 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-lg">
                        Calcular
                    </button>
                    <button type="button" id="generate-report-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-lg">
                        Gerar Relatório
                    </button>
                </div>
            </form>
            <div id="result-container" class="mt-8 text-center hidden">
                <p class="text-gray-400">Valor Final a ser Pago:</p>
                <p id="result-reais" class="text-4xl font-bold text-green-400 mt-2"></p>
                <p id="result-explanation" class="text-sm text-gray-300 mt-1"></p>
            </div>
        </div>
    </div>

    <!-- Report Section (hidden by default) -->
    <div id="report-section" class="hidden absolute top-0 left-0 w-full bg-white text-black p-4 sm:p-8">
        <div class="max-w-4xl mx-auto">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-8">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Relatório de Custos Veiculares</h1>
                    <p id="report-user" class="text-gray-600"></p>
                    <p id="report-date" class="text-gray-600"></p>
                </div>
                <div id="report-actions" class="flex flex-wrap items-center justify-start gap-2">
                    <button id="back-to-app-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg">Voltar</button>
                    <button id="share-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg">Compartilhar</button>
                    <button id="print-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg">Imprimir</button>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8 text-center">
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p class="text-sm font-bold text-gray-600">Total KM Rodados</p>
                    <p id="report-total-km" class="text-2xl font-bold text-gray-900"></p>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p class="text-sm font-bold text-gray-600">Preço Combustível</p>
                    <p id="report-fuel-price" class="text-2xl font-bold text-gray-900"></p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg">
                    <p class="text-sm font-bold text-yellow-800">Total Abastecido</p>
                    <p id="report-total-refueling" class="text-2xl font-bold text-yellow-900"></p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg border border-green-300">
                    <p class="text-sm font-bold text-green-800">Valor Final a Pagar</p>
                    <p id="report-final-value" class="text-2xl font-bold text-green-900"></p>
                </div>
            </div>

            <div class="mb-8 p-4 bg-gray-50 rounded-lg border">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Explicação do Cálculo</h2>
                <p class="text-gray-700">O valor final é o custo total de combustível e manutenção, subtraindo o que já foi pago em abastecimentos:</p>
                <ul class="list-disc list-inside mt-2 space-y-1 text-gray-600">
                    <li><b>Custo Bruto:</b> Soma do custo de combustível (KM rodado / 12 km/l) e manutenção (R$ 0,12 por KM).</li>
                    <li><b>Abatimento:</b> Subtração do valor total já registrado em abastecimentos.</li>
                </ul>
                <p class="mt-4 font-mono text-sm bg-gray-200 p-2 rounded">
                    Fórmula: Valor Final = ( (Total KM / 12 * Preço Litro) + (Total KM * 0.12) ) - Total Abastecido
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Detalhes das Viagens</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left">Data</th>
                                    <th class="py-2 px-4 border-b text-left">Observação</th>
                                    <th class="py-2 px-4 border-b text-right">KM</th>
                                </tr>
                            </thead>
                            <tbody id="report-history-table">
                                <!-- Trip rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Detalhes dos Abastecimentos</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left">Data</th>
                                    <th class="py-2 px-4 border-b text-left">Observação</th>
                                    <th class="py-2 px-4 border-b text-right">Valor (R$)</th>
                                </tr>
                            </thead>
                            <tbody id="report-refueling-table">
                                <!-- Refueling rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, getDocs, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ELEMENT REFERENCES ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        
        const addKmForm = document.getElementById('add-km-form');
        const newKmInput = document.getElementById('new-km');
        const newObsInput = document.getElementById('new-obs');
        
        const addRefuelingForm = document.getElementById('add-refueling-form');
        const refuelingValueInput = document.getElementById('refueling-value');
        const refuelingObsInput = document.getElementById('refueling-obs');

        const historyList = document.getElementById('history-list');
        const historyPlaceholder = document.getElementById('history-placeholder');
        const totalKmSpan = document.getElementById('total-km');
        const totalRefuelingSpan = document.getElementById('total-refueling');
        const resetBtn = document.getElementById('reset-btn');
        
        const maintenanceForm = document.getElementById('maintenance-form');
        const priceInput = document.getElementById('price');
        const resultContainer = document.getElementById('result-container');
        const resultReais = document.getElementById('result-reais');
        const resultExplanation = document.getElementById('result-explanation');
        
        const generateReportBtn = document.getElementById('generate-report-btn');
        const reportSection = document.getElementById('report-section');
        const printBtn = document.getElementById('print-btn');
        const shareBtn = document.getElementById('share-btn');
        const backToAppBtn = document.getElementById('back-to-app-btn');

        // --- APP STATE ---
        let db, auth, userId;
        let totalKmState = 0;
        let totalRefuelingState = 0;
        let tripsCollectionRef, refuelingsCollectionRef;
        let combinedHistoryState = [];
        let lastCalculation = { price: 0, finalValue: 0 };

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyDx6ck0EDiDKP0MvHjeeYHdBdO4iFLQX00",
            authDomain: "calculadora-veicular.firebaseapp.com",
            projectId: "calculadora-veicular",
            storageBucket: "calculadora-veicular.appspot.com",
            messagingSenderId: "463638882821",
            appId: "1:463638882821:web:17720fa4ea9af3e9ee4a6c"
        };

        const app = initializeApp(firebaseConfig);
        const appId = firebaseConfig.appId;
        db = getFirestore(app);
        auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                const basePath = `artifacts/${appId}/users/${userId}`;
                tripsCollectionRef = collection(db, `${basePath}/trips`);
                refuelingsCollectionRef = collection(db, `${basePath}/refuelings`);
                
                listenForHistory();
                
                userInfo.textContent = `Olá, ${user.displayName || user.email}`;
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
            } else {
                userId = null;
                tripsCollectionRef = null;
                refuelingsCollectionRef = null;
                
                historyList.innerHTML = '';
                historyList.appendChild(historyPlaceholder);
                historyPlaceholder.classList.remove('hidden');
                
                totalKmState = 0;
                totalRefuelingState = 0;
                totalKmSpan.textContent = '0';
                totalRefuelingSpan.textContent = '0.00';
                
                resultContainer.classList.add('hidden');
                priceInput.value = '';
                newKmInput.value = '';
                newObsInput.value = '';
                refuelingValueInput.value = '';
                refuelingObsInput.value = '';
                
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                reportSection.classList.add('hidden');
            }
        });

        // --- DATA HANDLING & UI ---
        const listenForHistory = () => {
            if (!tripsCollectionRef || !refuelingsCollectionRef) return;

            const qTrips = query(tripsCollectionRef);
            const qRefuelings = query(refuelingsCollectionRef);

            const unsubTrips = onSnapshot(qTrips, (snapshot) => {
                updateCombinedHistory();
            });
            const unsubRefuelings = onSnapshot(qRefuelings, (snapshot) => {
                updateCombinedHistory();
            });
        };
        
        const updateCombinedHistory = async () => {
            const tripsSnapshot = await getDocs(query(tripsCollectionRef));
            const refuelingsSnapshot = await getDocs(query(refuelingsCollectionRef));

            let currentTotalKm = 0;
            let currentTotalRefueling = 0;
            let combined = [];

            tripsSnapshot.forEach(doc => {
                const data = doc.data();
                currentTotalKm += data.km;
                combined.push({ id: doc.id, type: 'trip', ...data });
            });

            refuelingsSnapshot.forEach(doc => {
                const data = doc.data();
                currentTotalRefueling += data.value;
                combined.push({ id: doc.id, type: 'refueling', ...data });
            });

            combined.sort((a, b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0));
            combinedHistoryState = combined;

            historyList.innerHTML = '';
            if (combined.length === 0) {
                historyList.appendChild(historyPlaceholder);
                historyPlaceholder.classList.remove('hidden');
            } else {
                historyPlaceholder.classList.add('hidden');
                combined.forEach(item => {
                    const date = item.date ? item.date.toDate().toLocaleDateString('pt-BR') : 'Data inválida';
                    let element;
                    if (item.type === 'trip') {
                        element = createHistoryElement('bg-gray-700', date, `${item.km} KM`, item.obs, 'text-cyan-400');
                    } else { // refueling
                        element = createHistoryElement('bg-gray-700', date, `R$ ${item.value.toFixed(2)}`, item.obs, 'text-yellow-400');
                    }
                    historyList.appendChild(element);
                });
            }

            totalKmState = currentTotalKm;
            totalRefuelingState = currentTotalRefueling;
            totalKmSpan.textContent = currentTotalKm.toFixed(0);
            totalRefuelingSpan.textContent = currentTotalRefueling.toFixed(2);
        };

        const createHistoryElement = (bgColor, date, value, obs, valueColor) => {
            const div = document.createElement('div');
            div.className = `${bgColor} p-3 rounded-lg flex justify-between items-center`;
            const obsText = obs ? `<p class="text-xs text-gray-400 mt-1 truncate">${obs}</p>` : '';
            div.innerHTML = `
                <div>
                    <span class="text-sm text-gray-300">${date}</span>
                    ${obsText}
                </div>
                <span class="font-semibold ${valueColor} text-lg">${value}</span>
            `;
            return div;
        };


        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch((error) => {
                console.error("Authentication failed: ", error);
                alert("Falha no login com Google. Verifique o console para mais detalhes.");
            });
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        addKmForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const km = parseFloat(newKmInput.value);
            const obs = newObsInput.value.trim();
            if (!isNaN(km) && km > 0 && tripsCollectionRef) {
                try {
                    const tripData = { km: km, date: serverTimestamp(), type: 'trip' };
                    if (obs) tripData.obs = obs;
                    await addDoc(tripsCollectionRef, tripData);
                    newKmInput.value = '';
                    newObsInput.value = '';
                } catch (error) {
                    console.error("Error adding trip: ", error);
                }
            }
        });
        
        addRefuelingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const value = parseFloat(refuelingValueInput.value);
            const obs = refuelingObsInput.value.trim();
            if (!isNaN(value) && value > 0 && refuelingsCollectionRef) {
                try {
                    const refuelingData = { value: value, date: serverTimestamp(), type: 'refueling' };
                    if (obs) refuelingData.obs = obs;
                    await addDoc(refuelingsCollectionRef, refuelingData);
                    refuelingValueInput.value = '';
                    refuelingObsInput.value = '';
                } catch (error) {
                    console.error("Error adding refueling: ", error);
                }
            }
        });

        resetBtn.addEventListener('click', async () => {
            if (!window.confirm('Tem certeza que deseja apagar TODO o histórico (rodagens e abastecimentos)? Esta ação não pode ser desfeita.')) return;
            if (!tripsCollectionRef || !refuelingsCollectionRef) return;
            
            try {
                const batch = writeBatch(db);
                const tripsSnapshot = await getDocs(tripsCollectionRef);
                tripsSnapshot.forEach(doc => batch.delete(doc.ref));
                
                const refuelingsSnapshot = await getDocs(refuelingsCollectionRef);
                refuelingsSnapshot.forEach(doc => batch.delete(doc.ref));
                
                await batch.commit();
            } catch(error) {
                console.error("Error resetting history: ", error);
            }
        });

        maintenanceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const price = parseFloat(priceInput.value);
            if (isNaN(price) || price <= 0) {
                resultReais.textContent = 'Preço inválido';
                resultExplanation.textContent = 'Insira um valor válido para o combustível.';
                resultReais.classList.remove('text-green-400');
                resultReais.classList.add('text-red-400');
                resultContainer.classList.remove('hidden');
                lastCalculation = { price: 0, finalValue: 0 };
                return;
            }
            
            const fuelCost = (totalKmState / 12) * price;
            const maintenanceCost = totalKmState * 0.12;
            const grossValue = fuelCost + maintenanceCost;
            const finalValue = grossValue - totalRefuelingState;

            lastCalculation = { price, finalValue, grossValue, fuelCost, maintenanceCost };

            resultReais.textContent = `R$ ${finalValue.toFixed(2)}`;
            resultExplanation.textContent = `(Custo total de R$ ${grossValue.toFixed(2)} - R$ ${totalRefuelingState.toFixed(2)} já pagos)`;
            resultReais.classList.remove('text-red-400');
            resultReais.classList.add('text-green-400');
            resultContainer.classList.remove('hidden');
        });
        
        generateReportBtn.addEventListener('click', () => {
            if (lastCalculation.finalValue === undefined) {
                alert('Por favor, clique em "Calcular" primeiro para obter os valores antes de gerar o relatório.');
                return;
            }
            
            document.getElementById('report-user').textContent = `Usuário: ${auth.currentUser.displayName || auth.currentUser.email}`;
            document.getElementById('report-date').textContent = `Gerado em: ${new Date().toLocaleDateString('pt-BR')}`;
            document.getElementById('report-total-km').textContent = `${totalKmState.toFixed(0)} KM`;
            document.getElementById('report-fuel-price').textContent = `R$ ${lastCalculation.price.toFixed(2)}`;
            document.getElementById('report-total-refueling').textContent = `R$ ${totalRefuelingState.toFixed(2)}`;
            document.getElementById('report-final-value').textContent = `R$ ${lastCalculation.finalValue.toFixed(2)}`;

            const tripTableBody = document.getElementById('report-history-table');
            const refuelingTableBody = document.getElementById('report-refueling-table');
            tripTableBody.innerHTML = '';
            refuelingTableBody.innerHTML = '';

            const trips = combinedHistoryState.filter(item => item.type === 'trip');
            const refuelings = combinedHistoryState.filter(item => item.type === 'refueling');

            if (trips.length > 0) {
                trips.forEach(trip => {
                    const row = tripTableBody.insertRow();
                    const date = trip.date ? trip.date.toDate().toLocaleDateString('pt-BR') : 'N/A';
                    row.innerHTML = `
                        <td class="py-2 px-4 border-b">${date}</td>
                        <td class="py-2 px-4 border-b">${trip.obs || '-'}</td>
                        <td class="py-2 px-4 border-b text-right">${trip.km} KM</td>
                    `;
                });
            } else {
                tripTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4">Nenhuma viagem registrada.</td></tr>`;
            }

            if (refuelings.length > 0) {
                refuelings.forEach(refueling => {
                    const row = refuelingTableBody.insertRow();
                    const date = refueling.date ? refueling.date.toDate().toLocaleDateString('pt-BR') : 'N/A';
                    row.innerHTML = `
                        <td class="py-2 px-4 border-b">${date}</td>
                        <td class="py-2 px-4 border-b">${refueling.obs || '-'}</td>
                        <td class="py-2 px-4 border-b text-right">R$ ${refueling.value.toFixed(2)}</td>
                    `;
                });
            } else {
                refuelingTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4">Nenhum abastecimento registrado.</td></tr>`;
            }

            reportSection.classList.remove('hidden');
            appContainer.classList.add('hidden');
        });
        
        printBtn.addEventListener('click', () => window.print());

        shareBtn.addEventListener('click', async () => {
            const reportElement = document.getElementById('report-section');
            const reportActions = document.getElementById('report-actions');
            reportActions.style.visibility = 'hidden';
            
            try {
                const canvas = await html2canvas(reportElement, { scale: 2 }); // Higher scale for better quality
                canvas.toBlob(async (blob) => {
                    if (blob) {
                        const file = new File([blob], 'relatorio_custos.png', { type: 'image/png' });
                        const shareData = {
                            files: [file],
                            title: 'Relatório de Custos Veiculares',
                            text: 'Segue o relatório de custos do veículo.'
                        };
                        if (navigator.canShare && navigator.canShare(shareData)) {
                            await navigator.share(shareData);
                        } else {
                            alert('O compartilhamento de arquivos não é suportado neste navegador.');
                        }
                    }
                    reportActions.style.visibility = 'visible';
                }, 'image/png');
            } catch (error) {
                console.error('Erro ao gerar imagem:', error);
                alert('Ocorreu um erro ao gerar a imagem do relatório.');
                reportActions.style.visibility = 'visible';
            }
        });

        backToAppBtn.addEventListener('click', () => {
            reportSection.classList.add('hidden');
            appContainer.classList.remove('hidden');
        });

    </script>
</body>
</html>

